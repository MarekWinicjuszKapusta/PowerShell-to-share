# Script for OneDrive reinstall
# Created by Marek.Kapusta@fujitsu.com
# Last update: 10.03.2023 16:22

# Function to generate a timestamp that is added to the log file
function Get-TimeStamp {
    return "[{0:MM/dd/yy} {0:HH:mm:ss}]" -f (Get-Date)
}

# Function to generate a log file
$logsDir = "$ENV:SystemDrive\support\logs\apps"
if (!(Test-Path -Path $logsDir -PathType Container)) {
    New-Item -ItemType Directory -Path $logsDir | Out-Null
}
$LogFile = "$logsDir\OneDrveReinstall.log"

Function LogWrite {
    Param ([string]$logstring)
    Add-Content $Logfile -Value "$(Get-TimeStamp) $logstring"
}

# Function to check if OneDrive is installed
function Check-OneDrive {
    LogWrite "Checking if OneDrive is installed"
    if( Test-Path "$env:LOCALAPPDATA\Microsoft\Onedrive\OneDrive.exe" ) 
        {Write-Host "OneDrive is installed"
        LogWrite "OneDrive is installed"
    }
    else {write-host "OneDrive is not installed"
        LogWrite "OneDrive is not installed"
    }
}

$ErrorActionPreference = 'SilentlyContinue'

LogWrite "** STARTING OneDrive Reinstall Script **"

Check-OneDrive

#Uninstalling OneDrive
Start-Process "C:\Windows\SysWOW64\OneDriveSetup.exe" -ArgumentList " /uninstall"

Check-OneDrive

#Installing OneDrive
Start-Process "C:\Windows\SysWOW64\OneDriveSetup.exe"

Check-OneDrive

#End of the script
LogWrite "** End of the OneDrive Reinstall Script **"
